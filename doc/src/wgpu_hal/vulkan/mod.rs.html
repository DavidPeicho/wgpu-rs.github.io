<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `wgpu-hal/src/vulkan/mod.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>mod.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../source-script.js"></script><script defer src="../../../source-files.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../wgpu_hal/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../wgpu_hal/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../wgpu_hal/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="src-line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
</pre><pre class="rust"><code><span class="doccomment">/*!
# Vulkan API internals.

## Stack memory

Ash expects slices, which we don&#39;t generally have available.
We cope with this requirement by the combination of the following ways:
  - temporarily allocating `Vec` on heap, where overhead is permitted
  - growing temporary local storage
  - using `implace_it` on iterators

## Framebuffers and Render passes

Render passes are cached on the device and kept forever.

Framebuffers are also cached on the device, but they are removed when
any of the image views (they have) gets removed.
If Vulkan supports image-less framebuffers,
then the actual views are excluded from the framebuffer key.

## Fences

If timeline semaphores are available, they are used 1:1 with wgpu-hal fences.
Otherwise, we manage a pool of `VkFence` objects behind each `hal::Fence`.

!*/

</span><span class="kw">mod </span>adapter;
<span class="kw">mod </span>command;
<span class="kw">mod </span>conv;
<span class="kw">mod </span>device;
<span class="kw">mod </span>instance;

<span class="kw">use </span>std::{borrow::Borrow, ffi::CStr, fmt, num::NonZeroU32, sync::Arc};

<span class="kw">use </span>arrayvec::ArrayVec;
<span class="kw">use </span>ash::{
    extensions::{ext, khr},
    vk,
};
<span class="kw">use </span>parking_lot::Mutex;

<span class="kw">const </span>MILLIS_TO_NANOS: u64 = <span class="number">1_000_000</span>;
<span class="kw">const </span>MAX_TOTAL_ATTACHMENTS: usize = <span class="kw">crate</span>::MAX_COLOR_ATTACHMENTS * <span class="number">2 </span>+ <span class="number">1</span>;

<span class="kw">pub type </span>DropGuard = Box&lt;<span class="kw">dyn </span>std::any::Any + Send + Sync&gt;;

<span class="attribute">#[derive(Clone)]
</span><span class="kw">pub struct </span>Api;

<span class="kw">impl </span><span class="kw">crate</span>::Api <span class="kw">for </span>Api {
    <span class="kw">type </span>Instance = Instance;
    <span class="kw">type </span>Surface = Surface;
    <span class="kw">type </span>Adapter = Adapter;
    <span class="kw">type </span>Device = Device;

    <span class="kw">type </span>Queue = Queue;
    <span class="kw">type </span>CommandEncoder = CommandEncoder;
    <span class="kw">type </span>CommandBuffer = CommandBuffer;

    <span class="kw">type </span>Buffer = Buffer;
    <span class="kw">type </span>Texture = Texture;
    <span class="kw">type </span>SurfaceTexture = SurfaceTexture;
    <span class="kw">type </span>TextureView = TextureView;
    <span class="kw">type </span>Sampler = Sampler;
    <span class="kw">type </span>QuerySet = QuerySet;
    <span class="kw">type </span>Fence = Fence;

    <span class="kw">type </span>BindGroupLayout = BindGroupLayout;
    <span class="kw">type </span>BindGroup = BindGroup;
    <span class="kw">type </span>PipelineLayout = PipelineLayout;
    <span class="kw">type </span>ShaderModule = ShaderModule;
    <span class="kw">type </span>RenderPipeline = RenderPipeline;
    <span class="kw">type </span>ComputePipeline = ComputePipeline;
}

<span class="kw">struct </span>DebugUtils {
    extension: ext::DebugUtils,
    messenger: vk::DebugUtilsMessengerEXT,
}

<span class="kw">pub struct </span>InstanceShared {
    raw: ash::Instance,
    extensions: Vec&lt;<span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>CStr&gt;,
    drop_guard: <span class="prelude-ty">Option</span>&lt;DropGuard&gt;,
    flags: <span class="kw">crate</span>::InstanceFlags,
    debug_utils: <span class="prelude-ty">Option</span>&lt;DebugUtils&gt;,
    get_physical_device_properties: <span class="prelude-ty">Option</span>&lt;khr::GetPhysicalDeviceProperties2&gt;,
    entry: ash::Entry,
    has_nv_optimus: bool,
    android_sdk_version: u32,
    driver_api_version: u32,
}

<span class="kw">pub struct </span>Instance {
    shared: Arc&lt;InstanceShared&gt;,
}

<span class="kw">struct </span>Swapchain {
    raw: vk::SwapchainKHR,
    functor: khr::Swapchain,
    device: Arc&lt;DeviceShared&gt;,
    fence: vk::Fence,
    images: Vec&lt;vk::Image&gt;,
    config: <span class="kw">crate</span>::SurfaceConfiguration,
}

<span class="kw">pub struct </span>Surface {
    raw: vk::SurfaceKHR,
    functor: khr::Surface,
    instance: Arc&lt;InstanceShared&gt;,
    swapchain: <span class="prelude-ty">Option</span>&lt;Swapchain&gt;,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>SurfaceTexture {
    index: u32,
    texture: Texture,
}

<span class="kw">impl </span>Borrow&lt;Texture&gt; <span class="kw">for </span>SurfaceTexture {
    <span class="kw">fn </span>borrow(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>Texture {
        <span class="kw-2">&amp;</span><span class="self">self</span>.texture
    }
}

<span class="kw">pub struct </span>Adapter {
    raw: vk::PhysicalDevice,
    instance: Arc&lt;InstanceShared&gt;,
    <span class="comment">//queue_families: Vec&lt;vk::QueueFamilyProperties&gt;,
    </span>known_memory_flags: vk::MemoryPropertyFlags,
    phd_capabilities: adapter::PhysicalDeviceCapabilities,
    <span class="comment">//phd_features: adapter::PhysicalDeviceFeatures,
    </span>downlevel_flags: wgt::DownlevelFlags,
    private_caps: PrivateCapabilities,
    workarounds: Workarounds,
}

<span class="comment">// TODO there&#39;s no reason why this can&#39;t be unified--the function pointers should all be the same--it&#39;s not clear how to do this with `ash`.
</span><span class="kw">enum </span>ExtensionFn&lt;T&gt; {
    <span class="doccomment">/// The loaded function pointer struct for an extension.
    </span>Extension(T),
    <span class="doccomment">/// The extension was promoted to a core version of Vulkan and the functions on `ash`&#39;s `DeviceV1_x` traits should be used.
    </span>Promoted,
}

<span class="kw">struct </span>DeviceExtensionFunctions {
    draw_indirect_count: <span class="prelude-ty">Option</span>&lt;khr::DrawIndirectCount&gt;,
    timeline_semaphore: <span class="prelude-ty">Option</span>&lt;ExtensionFn&lt;khr::TimelineSemaphore&gt;&gt;,
}

<span class="doccomment">/// Set of internal capabilities, which don&#39;t show up in the exposed
/// device geometry, but affect the code paths taken internally.
</span><span class="attribute">#[derive(Clone, Debug)]
</span><span class="kw">struct </span>PrivateCapabilities {
    <span class="doccomment">/// Y-flipping is implemented with either `VK_AMD_negative_viewport_height` or `VK_KHR_maintenance1`/1.1+. The AMD extension for negative viewport height does not require a Y shift.
    ///
    /// This flag is `true` if the device has `VK_KHR_maintenance1`/1.1+ and `false` otherwise (i.e. in the case of `VK_AMD_negative_viewport_height`).
    </span>flip_y_requires_shift: bool,
    imageless_framebuffers: bool,
    image_view_usage: bool,
    timeline_semaphores: bool,
    texture_d24: bool,
    texture_d24_s8: bool,
    <span class="doccomment">/// Ability to present contents to any screen. Only needed to work around broken platform configurations.
    </span>can_present: bool,
    non_coherent_map_mask: wgt::BufferAddress,
    robust_buffer_access: bool,
    robust_image_access: bool,
}

<span class="macro">bitflags::bitflags!</span>(
    <span class="doccomment">/// Workaround flags.
    </span><span class="kw">pub struct </span>Workarounds: u32 {
        <span class="doccomment">/// Only generate SPIR-V for one entry point at a time.
        </span><span class="kw">const </span>SEPARATE_ENTRY_POINTS = <span class="number">0x1</span>;
        <span class="doccomment">/// Qualcomm OOMs when there are zero color attachments but a non-null pointer
        /// to a subpass resolve attachment array. This nulls out that pointer in that case.
        </span><span class="kw">const </span>EMPTY_RESOLVE_ATTACHMENT_LISTS = <span class="number">0x2</span>;
    }
);

<span class="attribute">#[derive(Clone, Debug, Eq, Hash, PartialEq)]
</span><span class="kw">struct </span>AttachmentKey {
    format: vk::Format,
    layout: vk::ImageLayout,
    ops: <span class="kw">crate</span>::AttachmentOps,
}

<span class="kw">impl </span>AttachmentKey {
    <span class="doccomment">/// Returns an attachment key for a compatible attachment.
    </span><span class="kw">fn </span>compatible(format: vk::Format, layout: vk::ImageLayout) -&gt; <span class="self">Self </span>{
        <span class="self">Self </span>{
            format,
            layout,
            ops: <span class="kw">crate</span>::AttachmentOps::all(),
        }
    }
}

<span class="attribute">#[derive(Clone, Eq, Hash, PartialEq)]
</span><span class="kw">struct </span>ColorAttachmentKey {
    base: AttachmentKey,
    resolve: <span class="prelude-ty">Option</span>&lt;AttachmentKey&gt;,
}

<span class="attribute">#[derive(Clone, Eq, Hash, PartialEq)]
</span><span class="kw">struct </span>DepthStencilAttachmentKey {
    base: AttachmentKey,
    stencil_ops: <span class="kw">crate</span>::AttachmentOps,
}

<span class="attribute">#[derive(Clone, Eq, Default, Hash, PartialEq)]
</span><span class="kw">struct </span>RenderPassKey {
    colors: ArrayVec&lt;<span class="prelude-ty">Option</span>&lt;ColorAttachmentKey&gt;, { <span class="kw">crate</span>::MAX_COLOR_ATTACHMENTS }&gt;,
    depth_stencil: <span class="prelude-ty">Option</span>&lt;DepthStencilAttachmentKey&gt;,
    sample_count: u32,
    multiview: <span class="prelude-ty">Option</span>&lt;NonZeroU32&gt;,
}

<span class="attribute">#[derive(Clone, Debug, Eq, Hash, PartialEq)]
</span><span class="kw">struct </span>FramebufferAttachment {
    <span class="doccomment">/// Can be NULL if the framebuffer is image-less
    </span>raw: vk::ImageView,
    raw_image_flags: vk::ImageCreateFlags,
    view_usage: <span class="kw">crate</span>::TextureUses,
    view_format: wgt::TextureFormat,
}

<span class="attribute">#[derive(Clone, Eq, Hash, PartialEq)]
</span><span class="kw">struct </span>FramebufferKey {
    attachments: ArrayVec&lt;FramebufferAttachment, { MAX_TOTAL_ATTACHMENTS }&gt;,
    extent: wgt::Extent3d,
    sample_count: u32,
}

<span class="macro">bitflags::bitflags! </span>{
    <span class="kw">pub struct </span>UpdateAfterBindTypes: u8 {
        <span class="kw">const </span>UNIFORM_BUFFER = <span class="number">0x1</span>;
        <span class="kw">const </span>STORAGE_BUFFER = <span class="number">0x2</span>;
        <span class="kw">const </span>SAMPLED_TEXTURE = <span class="number">0x4</span>;
        <span class="kw">const </span>STORAGE_TEXTURE = <span class="number">0x8</span>;
    }
}

<span class="kw">impl </span>UpdateAfterBindTypes {
    <span class="kw">pub fn </span>from_limits(limits: <span class="kw-2">&amp;</span>wgt::Limits, phd_limits: <span class="kw-2">&amp;</span>vk::PhysicalDeviceLimits) -&gt; <span class="self">Self </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>uab_types = UpdateAfterBindTypes::empty();
        uab_types.set(
            UpdateAfterBindTypes::UNIFORM_BUFFER,
            limits.max_uniform_buffers_per_shader_stage
                &gt; phd_limits.max_per_stage_descriptor_uniform_buffers,
        );
        uab_types.set(
            UpdateAfterBindTypes::STORAGE_BUFFER,
            limits.max_storage_buffers_per_shader_stage
                &gt; phd_limits.max_per_stage_descriptor_storage_buffers,
        );
        uab_types.set(
            UpdateAfterBindTypes::SAMPLED_TEXTURE,
            limits.max_sampled_textures_per_shader_stage
                &gt; phd_limits.max_per_stage_descriptor_sampled_images,
        );
        uab_types.set(
            UpdateAfterBindTypes::STORAGE_TEXTURE,
            limits.max_storage_textures_per_shader_stage
                &gt; phd_limits.max_per_stage_descriptor_storage_images,
        );
        uab_types
    }

    <span class="kw">fn </span>from_features(features: <span class="kw-2">&amp;</span>adapter::PhysicalDeviceFeatures) -&gt; <span class="self">Self </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>uab_types = UpdateAfterBindTypes::empty();
        <span class="kw">if let </span><span class="prelude-val">Some</span>(di) = features.descriptor_indexing {
            uab_types.set(
                UpdateAfterBindTypes::UNIFORM_BUFFER,
                di.descriptor_binding_uniform_buffer_update_after_bind != <span class="number">0</span>,
            );
            uab_types.set(
                UpdateAfterBindTypes::STORAGE_BUFFER,
                di.descriptor_binding_storage_buffer_update_after_bind != <span class="number">0</span>,
            );
            uab_types.set(
                UpdateAfterBindTypes::SAMPLED_TEXTURE,
                di.descriptor_binding_sampled_image_update_after_bind != <span class="number">0</span>,
            );
            uab_types.set(
                UpdateAfterBindTypes::STORAGE_TEXTURE,
                di.descriptor_binding_storage_image_update_after_bind != <span class="number">0</span>,
            );
        }
        uab_types
    }
}

<span class="kw">struct </span>DeviceShared {
    raw: ash::Device,
    family_index: u32,
    queue_index: u32,
    raw_queue: ash::vk::Queue,
    handle_is_owned: bool,
    instance: Arc&lt;InstanceShared&gt;,
    physical_device: ash::vk::PhysicalDevice,
    enabled_extensions: Vec&lt;<span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>CStr&gt;,
    extension_fns: DeviceExtensionFunctions,
    vendor_id: u32,
    timestamp_period: f32,
    uab_types: UpdateAfterBindTypes,
    downlevel_flags: wgt::DownlevelFlags,
    private_caps: PrivateCapabilities,
    workarounds: Workarounds,
    render_passes: Mutex&lt;fxhash::FxHashMap&lt;RenderPassKey, vk::RenderPass&gt;&gt;,
    framebuffers: Mutex&lt;fxhash::FxHashMap&lt;FramebufferKey, vk::Framebuffer&gt;&gt;,
}

<span class="kw">pub struct </span>Device {
    shared: Arc&lt;DeviceShared&gt;,
    mem_allocator: Mutex&lt;gpu_alloc::GpuAllocator&lt;vk::DeviceMemory&gt;&gt;,
    desc_allocator:
        Mutex&lt;gpu_descriptor::DescriptorAllocator&lt;vk::DescriptorPool, vk::DescriptorSet&gt;&gt;,
    valid_ash_memory_types: u32,
    naga_options: naga::back::spv::Options,
    <span class="attribute">#[cfg(feature = <span class="string">&quot;renderdoc&quot;</span>)]
    </span>render_doc: <span class="kw">crate</span>::auxil::renderdoc::RenderDoc,
}

<span class="kw">pub struct </span>Queue {
    raw: vk::Queue,
    swapchain_fn: khr::Swapchain,
    device: Arc&lt;DeviceShared&gt;,
    family_index: u32,
    <span class="doccomment">/// We use a redundant chain of semaphores to pass on the signal
    /// from submissions to the last present, since it&#39;s required by the
    /// specification.
    /// It would be correct to use a single semaphore there, but
    /// [Intel hangs in `anv_queue_finish`](https://gitlab.freedesktop.org/mesa/mesa/-/issues/5508).
    </span>relay_semaphores: [vk::Semaphore; <span class="number">2</span>],
    relay_index: <span class="prelude-ty">Option</span>&lt;usize&gt;,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>Buffer {
    raw: vk::Buffer,
    block: Mutex&lt;gpu_alloc::MemoryBlock&lt;vk::DeviceMemory&gt;&gt;,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>Texture {
    raw: vk::Image,
    drop_guard: <span class="prelude-ty">Option</span>&lt;DropGuard&gt;,
    block: <span class="prelude-ty">Option</span>&lt;gpu_alloc::MemoryBlock&lt;vk::DeviceMemory&gt;&gt;,
    usage: <span class="kw">crate</span>::TextureUses,
    aspects: <span class="kw">crate</span>::FormatAspects,
    format_info: wgt::TextureFormatInfo,
    raw_flags: vk::ImageCreateFlags,
    copy_size: <span class="kw">crate</span>::CopyExtent,
}

<span class="kw">impl </span>Texture {
    <span class="doccomment">/// # Safety
    ///
    /// - The image handle must not be manually destroyed
    </span><span class="kw">pub unsafe fn </span>raw_handle(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; vk::Image {
        <span class="self">self</span>.raw
    }
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>TextureView {
    raw: vk::ImageView,
    layers: NonZeroU32,
    attachment: FramebufferAttachment,
}

<span class="kw">impl </span>TextureView {
    <span class="kw">fn </span>aspects(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw">crate</span>::FormatAspects {
        <span class="self">self</span>.attachment.view_format.into()
    }
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>Sampler {
    raw: vk::Sampler,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>BindGroupLayout {
    raw: vk::DescriptorSetLayout,
    desc_count: gpu_descriptor::DescriptorTotalCount,
    types: Box&lt;[(vk::DescriptorType, u32)]&gt;,
    <span class="doccomment">/// Map of binding index to size,
    </span>binding_arrays: Vec&lt;(u32, NonZeroU32)&gt;,
    requires_update_after_bind: bool,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>PipelineLayout {
    raw: vk::PipelineLayout,
    binding_arrays: naga::back::spv::BindingMap,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>BindGroup {
    set: gpu_descriptor::DescriptorSet&lt;vk::DescriptorSet&gt;,
}

<span class="attribute">#[derive(Default)]
</span><span class="kw">struct </span>Temp {
    marker: Vec&lt;u8&gt;,
    buffer_barriers: Vec&lt;vk::BufferMemoryBarrier&gt;,
    image_barriers: Vec&lt;vk::ImageMemoryBarrier&gt;,
}

<span class="kw">unsafe impl </span>Send <span class="kw">for </span>Temp {}
<span class="kw">unsafe impl </span>Sync <span class="kw">for </span>Temp {}

<span class="kw">impl </span>Temp {
    <span class="kw">fn </span>clear(<span class="kw-2">&amp;mut </span><span class="self">self</span>) {
        <span class="self">self</span>.marker.clear();
        <span class="self">self</span>.buffer_barriers.clear();
        <span class="self">self</span>.image_barriers.clear();
        <span class="comment">//see also - https://github.com/NotIntMan/inplace_it/issues/8
    </span>}

    <span class="kw">fn </span>make_c_str(<span class="kw-2">&amp;mut </span><span class="self">self</span>, name: <span class="kw-2">&amp;</span>str) -&gt; <span class="kw-2">&amp;</span>CStr {
        <span class="self">self</span>.marker.clear();
        <span class="self">self</span>.marker.extend_from_slice(name.as_bytes());
        <span class="self">self</span>.marker.push(<span class="number">0</span>);
        <span class="kw">unsafe </span>{ CStr::from_bytes_with_nul_unchecked(<span class="kw-2">&amp;</span><span class="self">self</span>.marker) }
    }
}

<span class="kw">pub struct </span>CommandEncoder {
    raw: vk::CommandPool,
    device: Arc&lt;DeviceShared&gt;,
    active: vk::CommandBuffer,
    bind_point: vk::PipelineBindPoint,
    temp: Temp,
    free: Vec&lt;vk::CommandBuffer&gt;,
    discarded: Vec&lt;vk::CommandBuffer&gt;,
    <span class="doccomment">/// If this is true, the active renderpass enabled a debug span,
    /// and needs to be disabled on renderpass close.
    </span>rpass_debug_marker_active: bool,
}

<span class="kw">impl </span>fmt::Debug <span class="kw">for </span>CommandEncoder {
    <span class="kw">fn </span>fmt(<span class="kw-2">&amp;</span><span class="self">self</span>, f: <span class="kw-2">&amp;mut </span>fmt::Formatter&lt;<span class="lifetime">&#39;_</span>&gt;) -&gt; fmt::Result {
        f.debug_struct(<span class="string">&quot;CommandEncoder&quot;</span>)
            .field(<span class="string">&quot;raw&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.raw)
            .finish()
    }
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>CommandBuffer {
    raw: vk::CommandBuffer,
}

<span class="attribute">#[derive(Debug)]
#[allow(clippy::large_enum_variant)]
</span><span class="kw">pub enum </span>ShaderModule {
    Raw(vk::ShaderModule),
    Intermediate {
        naga_shader: <span class="kw">crate</span>::NagaShader,
        runtime_checks: bool,
    },
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>RenderPipeline {
    raw: vk::Pipeline,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>ComputePipeline {
    raw: vk::Pipeline,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>QuerySet {
    raw: vk::QueryPool,
}

<span class="attribute">#[derive(Debug)]
</span><span class="kw">pub enum </span>Fence {
    TimelineSemaphore(vk::Semaphore),
    FencePool {
        last_completed: <span class="kw">crate</span>::FenceValue,
        <span class="doccomment">/// The pending fence values have to be ascending.
        </span>active: Vec&lt;(<span class="kw">crate</span>::FenceValue, vk::Fence)&gt;,
        free: Vec&lt;vk::Fence&gt;,
    },
}

<span class="kw">impl </span>Fence {
    <span class="kw">fn </span>check_active(
        device: <span class="kw-2">&amp;</span>ash::Device,
        <span class="kw-2">mut </span>max_value: <span class="kw">crate</span>::FenceValue,
        active: <span class="kw-2">&amp;</span>[(<span class="kw">crate</span>::FenceValue, vk::Fence)],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="kw">crate</span>::FenceValue, <span class="kw">crate</span>::DeviceError&gt; {
        <span class="kw">for </span><span class="kw-2">&amp;</span>(value, raw) <span class="kw">in </span>active.iter() {
            <span class="kw">unsafe </span>{
                <span class="kw">if </span>value &gt; max_value &amp;&amp; device.get_fence_status(raw)<span class="question-mark">? </span>{
                    max_value = value;
                }
            }
        }
        <span class="prelude-val">Ok</span>(max_value)
    }

    <span class="kw">fn </span>get_latest(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        device: <span class="kw-2">&amp;</span>ash::Device,
        extension: <span class="prelude-ty">Option</span>&lt;<span class="kw-2">&amp;</span>ExtensionFn&lt;khr::TimelineSemaphore&gt;&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="kw">crate</span>::FenceValue, <span class="kw">crate</span>::DeviceError&gt; {
        <span class="kw">match </span><span class="kw-2">*</span><span class="self">self </span>{
            <span class="self">Self</span>::TimelineSemaphore(raw) =&gt; <span class="kw">unsafe </span>{
                <span class="prelude-val">Ok</span>(<span class="kw">match </span><span class="kw-2">*</span>extension.unwrap() {
                    ExtensionFn::Extension(<span class="kw-2">ref </span>ext) =&gt; ext.get_semaphore_counter_value(raw)<span class="question-mark">?</span>,
                    ExtensionFn::Promoted =&gt; device.get_semaphore_counter_value(raw)<span class="question-mark">?</span>,
                })
            },
            <span class="self">Self</span>::FencePool {
                last_completed,
                <span class="kw-2">ref </span>active,
                free: <span class="kw">_</span>,
            } =&gt; <span class="self">Self</span>::check_active(device, last_completed, active),
        }
    }

    <span class="kw">fn </span>maintain(<span class="kw-2">&amp;mut </span><span class="self">self</span>, device: <span class="kw-2">&amp;</span>ash::Device) -&gt; <span class="prelude-ty">Result</span>&lt;(), <span class="kw">crate</span>::DeviceError&gt; {
        <span class="kw">match </span><span class="kw-2">*</span><span class="self">self </span>{
            <span class="self">Self</span>::TimelineSemaphore(<span class="kw">_</span>) =&gt; {}
            <span class="self">Self</span>::FencePool {
                <span class="kw-2">ref mut </span>last_completed,
                <span class="kw-2">ref mut </span>active,
                <span class="kw-2">ref mut </span>free,
            } =&gt; {
                <span class="kw">let </span>latest = <span class="self">Self</span>::check_active(device, <span class="kw-2">*</span>last_completed, active)<span class="question-mark">?</span>;
                <span class="kw">let </span>base_free = free.len();
                <span class="kw">for </span><span class="kw-2">&amp;</span>(value, raw) <span class="kw">in </span>active.iter() {
                    <span class="kw">if </span>value &lt;= latest {
                        free.push(raw);
                    }
                }
                <span class="kw">if </span>free.len() != base_free {
                    active.retain(|<span class="kw-2">&amp;</span>(value, <span class="kw">_</span>)| value &gt; latest);
                    <span class="kw">unsafe </span>{
                        device.reset_fences(<span class="kw-2">&amp;</span>free[base_free..])<span class="question-mark">?</span>;
                    }
                }
                <span class="kw-2">*</span>last_completed = latest;
            }
        }
        <span class="prelude-val">Ok</span>(())
    }
}

<span class="kw">impl </span><span class="kw">crate</span>::Queue&lt;Api&gt; <span class="kw">for </span>Queue {
    <span class="kw">unsafe fn </span>submit(
        <span class="kw-2">&amp;mut </span><span class="self">self</span>,
        command_buffers: <span class="kw-2">&amp;</span>[<span class="kw-2">&amp;</span>CommandBuffer],
        signal_fence: <span class="prelude-ty">Option</span>&lt;(<span class="kw-2">&amp;mut </span>Fence, <span class="kw">crate</span>::FenceValue)&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(), <span class="kw">crate</span>::DeviceError&gt; {
        <span class="kw">let </span>vk_cmd_buffers = command_buffers
            .iter()
            .map(|cmd| cmd.raw)
            .collect::&lt;Vec&lt;<span class="kw">_</span>&gt;&gt;();

        <span class="kw">let </span><span class="kw-2">mut </span>vk_info = vk::SubmitInfo::builder().command_buffers(<span class="kw-2">&amp;</span>vk_cmd_buffers);

        <span class="kw">let </span><span class="kw-2">mut </span>fence_raw = vk::Fence::null();
        <span class="kw">let </span><span class="kw-2">mut </span>vk_timeline_info;
        <span class="kw">let </span><span class="kw-2">mut </span>signal_semaphores = [vk::Semaphore::null(), vk::Semaphore::null()];
        <span class="kw">let </span>signal_values;

        <span class="kw">if let </span><span class="prelude-val">Some</span>((fence, value)) = signal_fence {
            fence.maintain(<span class="kw-2">&amp;</span><span class="self">self</span>.device.raw)<span class="question-mark">?</span>;
            <span class="kw">match </span><span class="kw-2">*</span>fence {
                Fence::TimelineSemaphore(raw) =&gt; {
                    signal_values = [!<span class="number">0</span>, value];
                    signal_semaphores[<span class="number">1</span>] = raw;
                    vk_timeline_info = vk::TimelineSemaphoreSubmitInfo::builder()
                        .signal_semaphore_values(<span class="kw-2">&amp;</span>signal_values);
                    vk_info = vk_info.push_next(<span class="kw-2">&amp;mut </span>vk_timeline_info);
                }
                Fence::FencePool {
                    <span class="kw-2">ref mut </span>active,
                    <span class="kw-2">ref mut </span>free,
                    ..
                } =&gt; {
                    fence_raw = <span class="kw">match </span>free.pop() {
                        <span class="prelude-val">Some</span>(raw) =&gt; raw,
                        <span class="prelude-val">None </span>=&gt; <span class="self">self
                            </span>.device
                            .raw
                            .create_fence(<span class="kw-2">&amp;</span>vk::FenceCreateInfo::builder(), <span class="prelude-val">None</span>)<span class="question-mark">?</span>,
                    };
                    active.push((value, fence_raw));
                }
            }
        }

        <span class="kw">let </span>wait_stage_mask = [vk::PipelineStageFlags::TOP_OF_PIPE];
        <span class="kw">let </span>sem_index = <span class="kw">match </span><span class="self">self</span>.relay_index {
            <span class="prelude-val">Some</span>(old_index) =&gt; {
                vk_info = vk_info
                    .wait_semaphores(<span class="kw-2">&amp;</span><span class="self">self</span>.relay_semaphores[old_index..old_index + <span class="number">1</span>])
                    .wait_dst_stage_mask(<span class="kw-2">&amp;</span>wait_stage_mask);
                (old_index + <span class="number">1</span>) % <span class="self">self</span>.relay_semaphores.len()
            }
            <span class="prelude-val">None </span>=&gt; <span class="number">0</span>,
        };
        <span class="self">self</span>.relay_index = <span class="prelude-val">Some</span>(sem_index);
        signal_semaphores[<span class="number">0</span>] = <span class="self">self</span>.relay_semaphores[sem_index];

        <span class="kw">let </span>signal_count = <span class="kw">if </span>signal_semaphores[<span class="number">1</span>] == vk::Semaphore::null() {
            <span class="number">1
        </span>} <span class="kw">else </span>{
            <span class="number">2
        </span>};
        vk_info = vk_info.signal_semaphores(<span class="kw-2">&amp;</span>signal_semaphores[..signal_count]);

        <span class="macro">profiling::scope!</span>(<span class="string">&quot;vkQueueSubmit&quot;</span>);
        <span class="self">self</span>.device
            .raw
            .queue_submit(<span class="self">self</span>.raw, <span class="kw-2">&amp;</span>[vk_info.build()], fence_raw)<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">unsafe fn </span>present(
        <span class="kw-2">&amp;mut </span><span class="self">self</span>,
        surface: <span class="kw-2">&amp;mut </span>Surface,
        texture: SurfaceTexture,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(), <span class="kw">crate</span>::SurfaceError&gt; {
        <span class="kw">let </span>ssc = surface.swapchain.as_ref().unwrap();

        <span class="kw">let </span>swapchains = [ssc.raw];
        <span class="kw">let </span>image_indices = [texture.index];
        <span class="kw">let </span><span class="kw-2">mut </span>vk_info = vk::PresentInfoKHR::builder()
            .swapchains(<span class="kw-2">&amp;</span>swapchains)
            .image_indices(<span class="kw-2">&amp;</span>image_indices);

        <span class="kw">if let </span><span class="prelude-val">Some</span>(old_index) = <span class="self">self</span>.relay_index.take() {
            vk_info = vk_info.wait_semaphores(<span class="kw-2">&amp;</span><span class="self">self</span>.relay_semaphores[old_index..old_index + <span class="number">1</span>]);
        }

        <span class="kw">let </span>suboptimal = {
            <span class="macro">profiling::scope!</span>(<span class="string">&quot;vkQueuePresentKHR&quot;</span>);
            <span class="self">self</span>.swapchain_fn
                .queue_present(<span class="self">self</span>.raw, <span class="kw-2">&amp;</span>vk_info)
                .map_err(|error| <span class="kw">match </span>error {
                    vk::Result::ERROR_OUT_OF_DATE_KHR =&gt; <span class="kw">crate</span>::SurfaceError::Outdated,
                    vk::Result::ERROR_SURFACE_LOST_KHR =&gt; <span class="kw">crate</span>::SurfaceError::Lost,
                    <span class="kw">_ </span>=&gt; <span class="kw">crate</span>::DeviceError::from(error).into(),
                })<span class="question-mark">?
        </span>};
        <span class="kw">if </span>suboptimal {
            <span class="macro">log::warn!</span>(<span class="string">&quot;Suboptimal present of frame {}&quot;</span>, texture.index);
        }
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">unsafe fn </span>get_timestamp_period(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; f32 {
        <span class="self">self</span>.device.timestamp_period
    }
}

<span class="kw">impl </span>From&lt;vk::Result&gt; <span class="kw">for </span><span class="kw">crate</span>::DeviceError {
    <span class="kw">fn </span>from(result: vk::Result) -&gt; <span class="self">Self </span>{
        <span class="kw">match </span>result {
            vk::Result::ERROR_OUT_OF_HOST_MEMORY | vk::Result::ERROR_OUT_OF_DEVICE_MEMORY =&gt; {
                <span class="self">Self</span>::OutOfMemory
            }
            vk::Result::ERROR_DEVICE_LOST =&gt; <span class="self">Self</span>::Lost,
            <span class="kw">_ </span>=&gt; {
                <span class="macro">log::warn!</span>(<span class="string">&quot;Unrecognized device error {:?}&quot;</span>, result);
                <span class="self">Self</span>::Lost
            }
        }
    }
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="wgpu_hal" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.66.0-nightly (8b0c05d9a 2022-10-07)" ></div></body></html>